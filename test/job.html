<html>
<head>
<link type="text/css" rel="stylesheet" href="/public/css/layout-default-latest.css" />
<script type="text/javascript" src="/public/js/jquery.min.js"></script>
<script type="text/javascript" src="/public/js/jquery-ui.js"></script>
<script type="text/javascript" src="/public/js/jquery.layout.js"></script>
</head>
<body>
<div class="ui-layout-north">
  <b>Control Panel</b>
	<button id="add-client">Add a new Client</button>
	<button id="close-clients">Close Clients</button>
	<button id="submit-job">Submit Job</button>
</div>

<div class="ui-layout-west">
<ul id="clients"><ul>
</div>
<div class="ui-layout-east">east</div>

<div class="ui-layout-center">
	<div id="main">center</div>
	
</div>
<div class="ui-layout-south">
<div>Messages: <div>
<div id="messages"></div>
</div>

<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="/socket.io/mapred.io.js"></script>
<script type="text/javascript" >
jQuery(document).unload(function(){
  alert("Goodbye!");
});


jQuery(document).ready(function () {
	jQuery('body').layout({west__size: 300, south__size: 300});
})
var socket = io.connect();
jQuery(window).bind('beforeunload',function(){ 
	socket.emit('disconnect', 'leave cluster.');
}); 

var MapredClient = new MapredClient(socket, {messageCallback: function(data){
		jQuery('#messages').prepend('<p>'+ data+ '</p>');
	}, log: function(data){
		jQuery('#messages').prepend('<p>'+ data+ '</p>');
	}, resultCallback: function(data){
		jQuery('#messages').prepend('<p>'+ JSON.stringify(data)+ '</p>');
	}
});
socket.on('join', function(data){
	console.log(data)
	jQuery('#clients').append('<li id="' + data+ '">' + data+ '</li>');
	jQuery('#messages').prepend('<p>'+ data + 'have been joined in this cluster.' + '</p>');
})
socket.on('leave', function(data){
	jQuery('#' + data).remove();
	jQuery('#messages').prepend('<p>'+ data + 'will leave this cluster.' + '</p>');
})
var child = [];
$('#add-client').click(function(){
	var l = child.length, top = 250 + l*10; left = 300 + l*10;
	child.push(window.open('/client','','height=80,width=200,top='+top+',left='+left+',toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no'));
});
$('#close-clients').click(function(){ for (var i in child) child[i].close();})

$('#submit-job').click(function (){
	socket.emit('job', { map: (function(key, value){
		var list = [], aux = {};
		value = value.split(' ');
		value.forEach(function(w){
			aux[w] = (aux[w] || 0) + 1;
		});
		for(var k in aux){
			list.push([k, aux[k]]);
		}
		return list;
	}).toString(), reduce: (function(key, values){
		var sum = 0;
		values.forEach(function(e){
			sum += e;
		});
		return sum;
	}).toString(), inputs:[
		['frase primera', 'primer trozo de informacion para procesado primer trozo'],
		['segunda frase', 'segundo trozo de informacion trozo de'],
		['cacho 3', 'otro trozo para ser procesado otro otro otro trozo'],
		['cuarta frase', 'primer trozo de informacion para procesado primer trozo'],
		['frase 5', 'segundo trozo de informacion trozo de'],
		['frase primera', 'primer trozo de informacion para procesado primer trozo'],
		['segunda frase', 'segundo trozo de informacion trozo de'],
		['cacho 3', 'otro trozo para ser procesado otro otro otro trozo'],
		['cuarta frase', 'primer trozo de informacion para procesado primer trozo'],
		['frase 5', 'segundo trozo de informacion trozo de'],
		['frase primera', 'primer trozo de informacion para procesado primer trozo'],
		['segunda frase', 'segundo trozo de informacion trozo de'],
		['cacho 3', 'otro trozo para ser procesado otro otro otro trozo'],
		['cuarta frase', 'primer trozo de informacion para procesado primer trozo'],
		['frase 5', 'segundo trozo de informacion trozo de'],
		['frase primera', 'primer trozo de informacion para procesado primer trozo'],
		['segunda frase', 'segundo trozo de informacion trozo de']
  ] });
});
</script>
</body>
</html>
